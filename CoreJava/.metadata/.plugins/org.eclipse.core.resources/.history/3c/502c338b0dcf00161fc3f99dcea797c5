package dao;

import java.sql.ResultSet;
import java.sql.SQLException;

import models.Parking;
import models.Vehicle;

import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

@Repository
public class ParkingDAO {

	JdbcTemplate template;

	public JdbcTemplate getTemplate() {
		return template;
	}

	public void setTemplate(JdbcTemplate template) {
		this.template = template;
	}
	
	public boolean allocateParking(Parking p){
		String s= "update parking_current set vehicle_reg_no=?, owner_mobile=?,"
				+ "entry_time=? where slot_id=(select min(slot_id) "
				+ "from parking_current where owner_mobile is null)";
		int c= template.update(s, p.getVeh().getVehicleNo(), p.getVeh().getOwnerNo(), p.getEntryTime());
		if(c==1)
			return true;
		else
			return false;
	}
	
	public boolean addNewSlot(String vehicleType){
		String s= "insert into current_parking values((select max(slot_Id)"
				+ "from parking_current where slot_type=?)"
				+ "?,null,null,null)";
		int c= template.update(s, vehicleType, vehicleType);
		if(c==1)
			return true;
		else
			return false;
		
	}
	
	public boolean Block(String slotID){
		String s= "update current_parking set owner_mobile='null' "
				+ "where slot_type=?)";
		int c= template.update(s, slotID);
		if(c==1)
			return true;
		else
			return false;
		
	}
	
	public Parking getParkInfo(String vehicleRegNo){
		String s= "select *from parking_current where vehicle_reg_no= ?";
		Parking p= template.queryForObject(s, new ParkingMapper(), vehicleRegNo);
		return p;
		
	}
	
	public boolean deallocateParking(String slotID){
		
	}
	
	public int totalSlots(String vehicleType){
		
	}
	
	public boolean availableSlots(String vehicleType){
		
	}
	
	private static class ParkingMapper implements RowMapper<Parking>{

		@Override
		public Parking mapRow(ResultSet r, int row) throws SQLException {
			Parking p= new Parking();
			p.setSlotId(r.getInt("slot_id"));
			//p.setEntryTime(r.getString("entry_time"));
			p.getVeh().setOwnerNo(r.getString("owner_mobile")));
			v.setOwnerNo(r.getString("owner_mobile"));
			v.setVehicleNo(r.getString("vehicle_reg_no"));
			v.setVehicleType(r.getString("slot_type"));
			p.setVeh(v);;
			p.setSlotId(r.getInt("slot_id"));
			return p;
			
		}
		
	}
	
	
}
